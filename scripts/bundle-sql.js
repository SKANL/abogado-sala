const fs = require('fs');
const path = require('path');

// Use process.cwd() to be safe about where we are running from
const projectRoot = process.cwd();
const sqlDir = path.join(projectRoot, '.agent/sql');
const outputDir = path.join(projectRoot, '../../../../Users/angua/.gemini/antigravity/brain/da22096b-e740-4dcf-aa65-18bf95f6bef2');
const outputFile = path.join(outputDir, 'master_schema.sql');

console.log(`Looking for SQL files in: ${sqlDir}`);

const files = [
  '00-init.sql',
  '01-tables.sql',
  '02-indexes.sql',
  '03-rls.sql',
  '04-triggers.sql',
  '05-functions.sql',
  '06-perf-optimization.sql',
  '07-stability-patches.sql',
  '08-integrity-checks.sql'
];

let content = '-- MASTER SCHEMA GENERATED BY AGENT\n-- Apply this in Supabase SQL Editor\n\n';

if (!fs.existsSync(outputDir)) {
    console.log(`Creating output directory: ${outputDir}`);
    fs.mkdirSync(outputDir, { recursive: true });
}

files.forEach(file => {
  const filePath = path.join(sqlDir, file);
  if (fs.existsSync(filePath)) {
    console.log(`Bundling ${file}...`);
    content += `\n-- START OF ${file} --\n`;
    content += fs.readFileSync(filePath, 'utf8');
    content += `\n-- END OF ${file} --\n`;
  } else {
    console.error(`ERROR: Missing file: ${filePath}`);
    process.exit(1);
  }
});

fs.writeFileSync(outputFile, content);
console.log(`SUCCESS: Generated ${outputFile}`);
